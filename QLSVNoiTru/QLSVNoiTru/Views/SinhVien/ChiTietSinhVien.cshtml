@using QLSVNoiTru.Database;
@using QLSVNoiTru.Models;
@{
    ViewBag.Title = "Thông tin sinh viên";
    SinhVien sinhvien = (SinhVien)ViewData["sinhvien"];
    List<Lop> lops = (List<Lop>)ViewData["lops"];
    List<PhiPhong> phiPhongs = (List<PhiPhong>)ViewData["phiPhongs"];
    string ngayTiepTheoCoTheNopTien = (string)ViewData["ngayTiepTheoCoTheNopTien"];
}
<script src="~/Plugins/ckfinder/ckfinder.js"></script>
<script>
    $("#SINHVIEN").addClass("active");
</script>
<div class="body">
    <section class="content">
        <div class="header">
            <div class="row">
                <div class="col-md-12">
                    <h4 class="header-title">Thông tin sinh viên</h4>
                </div>
                <div class="col-md-12" style="text-align:right;padding-right:20px;padding-bottom:20px">
                    @*<a target="_blank" href="/MauBieu/InHopDongNoiTru?maSinhVien=@sinhvien.MaSinhVien" class="btn btn-primary">In hợp đồng nội trú</a>
                        <a target="_blank" href="/MauBieu/InBienLaiThuTienCoc?maSinhVien=@sinhvien.MaSinhVien" class="btn btn-primary">In biên lai thu tiền cọc</a>
                        <a target="_blank" href="/MauBieu/InBienLaiThuPhong?maSinhVien=@sinhvien.MaSinhVien" class="btn btn-primary">In biên lai thu tiền phòng</a>*@
                    <a target="_blank" href="/MauBieu/InBienLaiThanhLyHopDong?maSinhVien=@sinhvien.MaSinhVien" class="btn btn-primary">In biên lai thanh lý hợp đồng</a>
                    <a target="_blank" href="/MauBieu/InDonXinRaNoiTru?maSinhVien=@sinhvien.MaSinhVien" class="btn btn-primary">In đơn xin ra nội trú</a>
                </div>
            </div>
        </div>
        <!-- CONTENT -->
        <div class="main-content">
            <form action="/SinhVien/CapNhatThongTin" method="post">
                <div class="row">
                    <div class="col-md-5">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label style="display: block;text-align: center;">Hình ảnh</label>
                                    <img id="img-logo" src="@sinhvien.HinhAnh">
                                    <input required value="@sinhvien.HinhAnh" id="Logo" style="display: none; width: 0px;" name="HinhAnh" class="upload">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Mã lớp <span class="required-field">(*)</span></label>
                                    <select required name="MaLop" class="form-control">
                                        <option value="">Chọn...</option>
                                        @for (int i = 0; i < lops.Count; i++)
                                        {
                                            <option @(sinhvien.MaLop == lops[i].MaLop ? "selected" : "") value="@lops[i].MaLop">@lops[i].TenLop</option>
                                        }
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Mã sinh viên <span class="required-field">(*)</span></label>
                                    <input readonly id="MaSinhVien" value="@sinhvien.MaSinhVien" required type="text" name="MaSinhVien" class="form-control" />
                                </div>
                                <div class="form-group">
                                    <label>Tên sinh viên <span class="required-field">(*)</span></label>
                                    <input required value="@sinhvien.TenSinhVien" name="TenSinhVien" type="text" class="form-control" />
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Số điện thoại</label>
                                    <input value="@sinhvien.SDT" name="SDT" type="text" class="form-control" />
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Ngày sinh <span class="required-field">(*)</span></label>
                                    <input required name="NgaySinh" value="@sinhvien.NgaySinh.ToString("yyyy-MM-dd")" type="date" class="form-control" />
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Giới tính <span class="required-field">(*)</span></label>
                                    <select name="GioiTinh" class="form-control">
                                        <option @(sinhvien.GioiTinh == "Nam" ? "selected" : "") value="Nam">Nam</option>
                                        <option @(sinhvien.GioiTinh != "Nam" ? "selected" : "") value="Nữ">Nữ</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Dân tộc <span class="required-field">(*)</span></label>
                                    <input required value="@sinhvien.DanToc" name="DanToc" type="text" class="form-control" />
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Phòng ở</label>
                                    <input readonly required value="@sinhvien.Phong.SoHieuPhong" name="DanToc" type="text" class="form-control" style="width:250px" />
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Trạng thái ở</label>
                                    <input readonly required value="@DataHelper.ConvertTrangThaiO(sinhvien.TrangThaiO.Value)" name="DanToc" type="text" class="form-control" style="width:250px" />
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="row">
                            <div class="form-group">
                                <label>Hộ khẩu</label>
                                <input value="@sinhvien.HoKhau" name="HoKhau" type="text" class="form-control" />
                            </div>
                            <div class="form-group">
                                <label>Ghi chú</label>
                                <textarea name="GhiChu" type="text" class="form-control" rows="6">@sinhvien.GhiChu</textarea>
                            </div>
                            <div class="form-group">
                                <label>Thành tích</label>
                                <textarea class="form-control" rows="5" readonly="readonly" style="border: none; background-color: inherit;">@sinhvien.KhenThuong</textarea>
                            </div>
                            <div class="col-md-12">
                                <div class="form-group">
                                    <label>Kỷ luật</label>
                                    @foreach (var item in sinhvien.SinhVienKyLuats)
                                    {
                                        if (item.Chon)
                                        {
                                            <p><b>Mức @(item.KyLuat.MucDo) - @(item.KyLuat.TenKyLuat)</b></p>
                                        }
                                    }
                                </div>
                                <hr />
                            </div>
                            <div class="col-md-12">
                                <div class="form-group">
                                    <label>Lịch sử chuyển phòng</label>
                                    @foreach (var item in sinhvien.SinhVienChuyenPhongs)
                                    {
                                        <p>
                                            Từ phòng <b>@item.SoHieuPhongCu</b> sang <b>@item.SoHieuPhongMoi</b> : @item.NgayCapNhat.ToString("dd/MM/yyyy HH:mm")
                                            <br />
                                            @item.GhiChu
                                            <hr />
                                        </p>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div style="padding:10px;border:1px solid #dcdcdc">
                            <h4>Thông tin đóng tiền phòng ký túc xá</h4>
                            <div>
                                @if (sinhvien.TrangThaiO != (int)TrangThaiO.CheckOut)
                                {
                                    <button type="button" onclick="noptienphong()" class="btn btn-success" style="margin-bottom:5px">Nộp tiền phòng</button>
                                }
                            </div>
                            <div>
                                <table cellpadding="0" cellspacing="0" border="0" class="table table-striped table-hover" id="thongtinnoptien">
                                    <thead>
                                        <tr>
                                            <th>Từ tháng</th>
                                            <th>Đến tháng</th>
                                            <th>Số tiền</th>
                                            <th></th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var item in phiPhongs)
                                        {
                                            <tr>
                                                <td>@item.Thang.ToString("MM-yyyy (dd)")</td>
                                                <input type="hidden" value="@ngayTiepTheoCoTheNopTien" name="NgayTiepTheo"/>
                                                <td>@item.DenThang.ToString("MM-yyyy (dd)")</td>
                                                <td>@item.SoTien</td>
                                                <td style="display: inline-flex;">
                                                    <span onclick="editTienPhong('@item.PhiPhongId','@item.Thang.ToString("yyyy-MM-dd")','@item.DenThang.ToString("yyyy-MM-dd")','@item.SoTien')" class="fa fa-edit fa-lg" style="cursor: pointer;margin-top: 10px;"></span>
                                                    <a target="_blank" href="/SinhVien/InBienLaiThuTienPhongByPhiPhong?phiphongId=@item.PhiPhongId" style="cursor: pointer;margin-left:10px;margin-top:6px;"><i class="fa fa-print fa-lg"></i></a> 
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-12 text-center">
                        <button class="btn btn-primary" type="submit">Cập nhật thông tin</button>
                        <a href="/SinhVien/DanhSachSinhVien" class="btn btn-success">Trở lại</a>
                    </div>
                </div>
            </form>
        </div>
        <!-- END: CONTENT -->
    </section>
</div>
<div id="modalDongTienPhong" class="modal fade" role="dialog">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">Thông tin nộp tiền phòng</h4>
            </div>
            <div class="modal-body">
                <form id="frmDongTienPhong" action="" method="post">
                    <input type="hidden" name="MaSinhVien" value="@sinhvien.MaSinhVien" />
                    <input type="hidden" name="PhiPhongId" value="" />
                    <div class="row">
                        <div class="col-md-12">
                            <div class="form-group">
                                <label>Từ tháng</label>
                                <div>
                                    <input required name="TuThang" value="" type="date" class="form-control" />
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Đến tháng</label>
                                <div>
                                    <input required name="DenThang" value="" type="date" class="form-control" />
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Số tiền (VNĐ)</label>
                                <div>
                                    <input required type="text" name="TienPhi" value="" class="form-control" />
                                </div>
                            </div>
                            <div class="text-center">
                            </div>
                        </div>
                        <div class="col-md-12 text-right">
                            <button class="btn btn-primary">Cập nhật</button>
                            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

    </div>
</div>
<script>
    function noptienphong() {
        var ngay_tiep_theo = $('[name="NgayTiepTheo"]').val();
        if (ngay_tiep_theo === '') {
            $('[name="TuThang"]').val()
        } else {
            $('[name="TuThang"]').val(ngay_tiep_theo).attr('min', ngay_tiep_theo);
            $('[name="DenThang"]').attr('min', ngay_tiep_theo);
        }
        document.getElementsByName("DenThang")[0].value = '';
        document.getElementsByName("TienPhi")[0].value = '';
        $("#frmDongTienPhong").attr("action", "/sinhvien/nopthemtienphong");
        $("#modalDongTienPhong").modal();
    }
    function editTienPhong(phiphongid, tuthang, denthang, sotien) {
        document.getElementsByName("PhiPhongId")[0].value = phiphongid;
        document.getElementsByName("TuThang")[0].value = tuthang;
        document.getElementsByName("DenThang")[0].value = denthang;
        document.getElementsByName("TienPhi")[0].value = sotien;
        $("#frmDongTienPhong").attr("action", "/sinhvien/capnhattienphong");
        $("#modalDongTienPhong").modal();
    }
    $(document).ready(function () {
        $('#thongtinnoptien').dataTable({
            bFilter: false,
            bInfo: false,
            bLengthChange: false,
            bSort: false
        });
        function setFileField(fileUrl) {
            $('#' + $(upload).attr('for')).val(fileUrl);
            $("#img-logo").attr("src", fileUrl);
        }

        $('input[name="NgaySinh"]').prop('max', function () {
            return new Date().toJSON().split('T')[0];
        });


        if (!$('.button-upload').length > 0) {
            var upload;
            var textBox = $('.upload');
            for (var i = 0; i < textBox.length; i++) {
                var uploadText = $(textBox[i]);
                uploadText.css('width', uploadText.width() - 70);
                uploadText.after('<button type="button" for="' + uploadText.attr('id') + '" class="button-upload btn btn-primary">Chọn ảnh</button>');
                $('.button-upload').click(function () {
                    upload = $(this);
                    // You can use the "CKFinder" class to render CKFinder in a page:
                    var finder = new CKFinder();
                    finder.basePath = '../files';
                    finder.selectActionFunction = setFileField;
                    finder.popup();
                });
            }
        }
    });
</script>